{%extends "base.html"%}
{%block title%}
Indice
{%endblock%}
{%block content%}
<input type="hidden" id="latitude" value="0.0">
<input type="hidden" id="longitude" value="0.0">
<script src="https://maps.googleapis.com/maps/api/js?key= AIzaSyDesV0pveJzriPnvtbAl--z-rwImMoImwg &callback=initMap"
async defer></script>
<script type="text/javascript">
	var map;
	var first=true;
	function getLocation() {
		
	    if (navigator.geolocation) {
	        navigator.geolocation.getCurrentPosition(getPos_callback,error,{enableHighAccuracy:true,timeout:60000, maximumAge:60000});
	    } else {
			alert("Su navegador no soporta geolocalización.");
		}
	}


	function error(e){

		var errors = { 
	    	1: 'Permiso denegado',
		    2: 'Posición no disponible',
		    3: 'Tiempo de espera terminado'
		};
		//alert("Error al obtener datos del GPS\n["+errors[e.code]+"]");
		$('#status').html("Error: "+errors[e.code]);
	}

	function getPos_callback(p){
		var lat=-1,long=-1;
		lat=p.coords.latitude;
		long=p.coords.longitude;
		$('#latitude').val(lat);
		$('#longitude').val(long);
		$('#status').html("Posición obtenida con exito!");
		if(first){
			reset_map();
			first=false;
		}
	}
	function test(){
		alert("done!");
	}
	function reset_map(){
		google.maps.event.trigger(map, 'resize');
		var lat=parseFloat($('#latitude').val());
		var long=parseFloat($('#longitude').val());
		if(map){
			  var target = new google.maps.LatLng(location.lat,location.lng);
			  map.panTo({lat: lat, lng: long});
			  map.setZoom(17);
		}
	}
	function initMap() {
		$('#map_box').collapse();
		$('#map').css('display','block');
		// Create a map object and specify the DOM element for display.
		var lat=parseFloat($('#latitude').val()),long=parseFloat($('#longitude').val());
	 map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: lat, lng: long},
    zoom: 8
  });
	}
</script>

<!-- Modal -->
<div id="modal_inicio" class="modal fade" role="dialog">
  <div class="modal-dialog modal-sm">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Bienvenido!</h4>
      </div>
      <div class="modal-body">
        <p><b>ValdiPar</b> es el servicio de información de paraderos de Valdivia.</p>
        <p>Esta es una aplicación gratuita para conocer los paraderos más cercanos a tu ubicación.</p>
        <p>Para poder funcionar, necesitamos que nos des permiso de acceder a tu GPS.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar mensaje</button>
      </div>
    </div>

  </div>
</div>



	<div class="well well-sm">
		<div class="container">
			<div id="status">Obteniendo información del GPS...</div>
			<button class="btn btn-default" data-toggle="collapse" data-target="#map_box">Mostrar/ocultar mapa</button>
			
			<div id="map_box" class="panel-collapse collapse in">
				<div style="display:none;width:100%;height:300px;" id="map"></div>
				<button class="btn btn-default" onclick="reset_map()"l>Reiniciar mapa</button>
			</div>
			
		</div>
	</div>

<script type="text/javascript">
	$( document ).ready(function() {
		getLocation();
		setInterval(function(){getLocation();},6000);

		//$('#map_box').collapse();
		//$('#modal_inicio').modal('show');
	});
</script>
{%endblock%}